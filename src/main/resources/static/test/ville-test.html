<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests Frontend - Gestion des Villes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Tests Frontend - Gestion des Villes</h1>
    <p>Cette page teste les fonctionnalit√©s CRUD des villes, notamment le bug de modification des d√©partements.</p>

    <div class="test-container">
        <h2>Test Sc√©nario Narbonne (H√©rault ‚Üí Aude)</h2>
        <p>Reproduit le bug rencontr√© : modification du d√©partement de Narbonne</p>
        <button onclick="testModificationNarbonne()">üß™ Tester Modification Narbonne</button>
        <button onclick="testCreationVille()">‚ûï Tester Cr√©ation Ville</button>
        <button onclick="testRecuperationVilles()">üìã Lister toutes les villes</button>
        <button onclick="clearLog()">üóëÔ∏è Vider le log</button>
    </div>

    <div class="test-container">
        <h3>R√©sultats des tests</h3>
        <div id="test-results"></div>
    </div>

    <div class="test-container">
        <h3>Log d√©taill√©</h3>
        <div id="test-log" class="log"></div>
    </div>

    <script>
        // Configuration API (comme dans app.js)
        const API_BASE_URL = 'http://localhost:8081';
        const API_ENDPOINTS = {
            villes: `${API_BASE_URL}/villes`,
            departements: `${API_BASE_URL}/departements`
        };

        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.innerHTML += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }

        function addTestResult(test, success, message) {
            testResults.push({ test, success, message, timestamp: new Date() });
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            testResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${result.success ? 'test-success' : 'test-error'}`;
                resultDiv.innerHTML = `
                    <strong>${result.test}</strong><br>
                    ${result.message}<br>
                    <small>${result.timestamp.toLocaleString()}</small>
                `;
                resultsDiv.appendChild(resultDiv);
            });
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
            testResults = [];
            updateResultsDisplay();
        }

        async function testRecuperationVilles() {
            log('D√©but du test de r√©cup√©ration des villes');
            
            try {
                const response = await fetch(API_ENDPOINTS.villes);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const villes = await response.json();
                log(`‚úÖ ${villes.length} villes r√©cup√©r√©es avec succ√®s`);
                
                // Afficher quelques villes pour debug
                villes.slice(0, 5).forEach(ville => {
                    log(`   - ${ville.nom} (${ville.nbHabitants} hab.) - ${ville.departement?.code} ${ville.departement?.nom}`);
                });
                
                addTestResult('R√©cup√©ration villes', true, `${villes.length} villes trouv√©es`);
                return villes;
                
            } catch (error) {
                log(`‚ùå Erreur lors de la r√©cup√©ration: ${error.message}`, 'error');
                addTestResult('R√©cup√©ration villes', false, error.message);
                throw error;
            }
        }

        async function testCreationVille() {
            log('D√©but du test de cr√©ation d\'une ville');
            
            const nouvelleVille = {
                nom: 'Test City',
                nbHabitants: 12345,
                departement: {
                    id: 1 // On assume que l'ID 1 existe (probablement Ain)
                }
            };

            try {
                const response = await fetch(API_ENDPOINTS.villes, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nouvelleVille)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
                }

                const villeCreee = await response.json();
                log(`‚úÖ Ville cr√©√©e: ${villeCreee.nom} (ID: ${villeCreee.id}) dans ${villeCreee.departement?.nom}`);
                
                addTestResult('Cr√©ation ville', true, `Test City cr√©√©e avec ID ${villeCreee.id}`);

                // Nettoyer en supprimant la ville test
                await supprimerVille(villeCreee.id);
                
                return villeCreee;

            } catch (error) {
                log(`‚ùå Erreur lors de la cr√©ation: ${error.message}`, 'error');
                addTestResult('Cr√©ation ville', false, error.message);
                throw error;
            }
        }

        async function supprimerVille(id) {
            try {
                const response = await fetch(`${API_ENDPOINTS.villes}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    log(`üóëÔ∏è Ville supprim√©e (ID: ${id})`);
                } else {
                    log(`‚ö†Ô∏è Erreur lors de la suppression de la ville ${id}: ${response.status}`, 'warn');
                }
            } catch (error) {
                log(`‚ùå Erreur lors de la suppression: ${error.message}`, 'error');
            }
        }

        async function testModificationNarbonne() {
            log('üß™ D√©but du test de modification de Narbonne (H√©rault ‚Üí Aude)');
            
            try {
                // √âtape 1: R√©cup√©rer toutes les villes pour trouver Narbonne
                log('üìã R√©cup√©ration de la liste des villes...');
                const villes = await testRecuperationVilles();
                
                const narbonne = villes.find(v => v.nom === 'Narbonne');
                if (!narbonne) {
                    throw new Error('Narbonne non trouv√©e dans les donn√©es');
                }
                
                log(`üéØ Narbonne trouv√©e - ID: ${narbonne.id}, D√©partement initial: ${narbonne.departement?.code} (${narbonne.departement?.nom})`);
                
                // √âtape 2: R√©cup√©rer les d√©partements pour trouver l'Aude
                log('üóÇÔ∏è R√©cup√©ration des d√©partements...');
                const deptsResponse = await fetch(API_ENDPOINTS.departements);
                if (!deptsResponse.ok) {
                    throw new Error(`Erreur r√©cup√©ration d√©partements: ${deptsResponse.status}`);
                }
                const departements = await deptsResponse.json();
                
                const aude = departements.find(d => d.code === '11');
                if (!aude) {
                    throw new Error('D√©partement Aude (11) non trouv√©');
                }
                
                log(`üóÇÔ∏è D√©partement Aude trouv√© - ID: ${aude.id}, Nom: ${aude.nom}`);
                
                // √âtape 3: Pr√©parer les donn√©es de modification
                const donneesModification = {
                    nom: narbonne.nom,
                    nbHabitants: narbonne.nbHabitants,
                    departement: {
                        id: aude.id
                    }
                };
                
                log(`üîÑ Modification de Narbonne vers l'Aude...`);
                log(`   Donn√©es envoy√©es: ${JSON.stringify(donneesModification, null, 2)}`);
                
                // √âtape 4: Ex√©cuter la modification
                const modifResponse = await fetch(`${API_ENDPOINTS.villes}/${narbonne.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(donneesModification)
                });

                if (!modifResponse.ok) {
                    const errorText = await modifResponse.text();
                    throw new Error(`Erreur HTTP ${modifResponse.status}: ${errorText}`);
                }

                const villeModifiee = await modifResponse.json();
                log(`‚úÖ R√©ponse de modification re√ßue: ${villeModifiee.nom} dans ${villeModifiee.departement?.code} (${villeModifiee.departement?.nom})`);
                
                // √âtape 5: V√©rification finale - re-r√©cup√©rer la ville
                log(`üîç V√©rification finale - r√©cup√©ration de Narbonne...`);
                const verificationResponse = await fetch(`${API_ENDPOINTS.villes}/${narbonne.id}`);
                
                if (!verificationResponse.ok) {
                    throw new Error(`Erreur v√©rification: ${verificationResponse.status}`);
                }
                
                const villeFinal = await verificationResponse.json();
                log(`üîç √âtat final de Narbonne: ${villeFinal.nom} dans ${villeFinal.departement?.code} (${villeFinal.departement?.nom})`);
                
                // √âtape 6: Validation du r√©sultat
                const success = villeFinal.departement?.code === '11';
                
                if (success) {
                    log(`‚úÖ TEST R√âUSSI: Narbonne est maintenant bien dans l'Aude (11)`);
                    addTestResult('Modification Narbonne', true, `D√©partement chang√© avec succ√®s: ${narbonne.departement?.code} ‚Üí 11`);
                } else {
                    log(`‚ùå TEST √âCHOU√â: Narbonne est encore dans ${villeFinal.departement?.code} au lieu de 11`, 'error');
                    addTestResult('Modification Narbonne', false, `D√©partement non modifi√©: encore dans ${villeFinal.departement?.code}`);
                }
                
                return success;
                
            } catch (error) {
                log(`‚ùå ERREUR dans le test de modification: ${error.message}`, 'error');
                addTestResult('Modification Narbonne', false, error.message);
                throw error;
            }
        }

        // Initialisation
        window.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page de tests charg√©e - Pr√™t pour les tests');
            log('üí° Cliquez sur les boutons pour ex√©cuter les tests');
        });
    </script>
</body>
</html>